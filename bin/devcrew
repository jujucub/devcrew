#!/bin/bash
set -e

DEVCREW_HOME="${DEVCREW_HOME:-$HOME/.devcrew}"
SESSION="devcrew"

# デフォルト値
MODE="team"  # team(4人) or duo(2人)
PROJECT_DIR=""
PERMISSION_MODE="restricted"  # restricted(dc-*のみ許可) or yolo(全許可)

# 色定義
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# ============================================================
# デフォルトエージェント設定
# ============================================================

# エージェントコマンド
AGENT_CLAUDE="claude"
AGENT_CODEX="codex"

# Team Mode (4人構成)
LEADER_AGENT="claude"
CODER_AGENT="claude"
REVIEWER_AGENT="claude"
TESTER_AGENT="claude"

# Duo Mode (2人構成)
CODER_DUO_AGENT="claude"
REVIEWER_DUO_AGENT="claude"

# エージェントオプション
CLAUDE_OPTIONS=""
CODEX_OPTIONS=""

# ============================================================
# 設定ファイル読み込み
# ============================================================
CONFIG_FILE="$DEVCREW_HOME/config"
if [ -f "$CONFIG_FILE" ]; then
  source "$CONFIG_FILE"
fi

# ============================================================
# パーミッション設定を取得
# ============================================================
get_permission_options() {
  local agent_type=$1
  local role=$2  # leader, coder, reviewer, tester

  # Leaderは常にデフォルト（ユーザー確認）
  if [ "$role" = "leader" ]; then
    echo ""
    return
  fi

  # yoloモードの場合は全許可
  if [ "$PERMISSION_MODE" = "yolo" ]; then
    case $agent_type in
      "claude") echo "--dangerously-skip-permissions" ;;
      "codex")  echo "--dangerously-bypass-approvals-and-sandbox" ;;
      *)        echo "" ;;
    esac
    return
  fi

  # restrictedモードの場合はdc-*コマンドのみ許可
  case $agent_type in
    "claude") echo "--allowedTools 'Bash(dc-send*) Bash(dc-status*)'" ;;
    "codex")  echo "--sandbox workspace-write --ask-for-approval on-request --add-dir $DEVCREW_HOME" ;;
    *)        echo "" ;;
  esac
}

# ============================================================
# エージェント起動コマンド生成
# ============================================================
get_agent_command() {
  local agent_type=$1
  local prompt_file=$2
  local role=$3
  local cmd=""
  local options=""
  local perm_options=""

  # パーミッションオプションを取得
  perm_options=$(get_permission_options "$agent_type" "$role")

  case $agent_type in
    "claude")
      cmd="$AGENT_CLAUDE"
      options="$CLAUDE_OPTIONS $perm_options"
      if [ -f "$prompt_file" ]; then
        echo "$cmd $options --system-prompt \"\$(cat '$prompt_file')\""
      else
        echo "$cmd $options"
      fi
      ;;
    "codex")
      cmd="$AGENT_CODEX"
      options="$CODEX_OPTIONS $perm_options"
      if [ -f "$prompt_file" ]; then
        # Codex CLIは experimental_instructions_file でシステムプロンプトを上書き
        echo "$cmd $options --config experimental_instructions_file='$prompt_file'"
      else
        echo "$cmd $options"
      fi
      ;;
    *)
      # カスタムエージェント
      local upper_type=$(echo "$agent_type" | tr '[:lower:]' '[:upper:]')
      local custom_var="AGENT_${upper_type}"
      eval "cmd=\${$custom_var:-$agent_type}"
      if [ -f "$prompt_file" ]; then
        echo "$cmd --system-prompt \"\$(cat '$prompt_file')\""
      else
        echo "$cmd"
      fi
      ;;
  esac
}

# ヘルプ
show_help() {
  cat << EOF
Usage: devcrew [OPTIONS] [PROJECT_DIR]

マルチエージェント協調開発環境

Options:
  -2, --duo       2人構成 (Coder + Reviewer)
  -4, --team      4人構成 (Leader + Coder + Reviewer + Tester) [default]
  -y, --yolo      全コマンド自動許可モード (危険)
  -c, --config    現在の設定を表示
  -k, --kill      既存のdevcrewセッションを終了
  -h, --help      このヘルプを表示

Permission Modes:
  [Default - restricted]
    Leaderのみユーザー確認、他はdc-send/dc-statusのみ許可

  [--yolo]
    全エージェントが全コマンドを自動実行 (セキュリティ注意)

Examples:
  devcrew                    # カレントディレクトリで4人構成
  devcrew -2                 # カレントディレクトリで2人構成
  devcrew -2 ~/projects/app  # 指定ディレクトリで2人構成
  devcrew --config           # 設定確認
  devcrew --kill             # セッション終了

Agents:
  [Team Mode - 4人]
    Leader   : タスク管理・指示出し
    Coder    : 実装担当
    Reviewer : コードレビュー
    Tester   : テスト担当

  [Duo Mode - 2人]
    Coder    : 実装担当
    Reviewer : コードレビュー

Supported Agents:
  claude   : Claude Code CLI
  codex    : OpenAI Codex CLI

Configuration:
  Edit ~/.devcrew/config to customize agent assignments.
  Example: CODER_AGENT="codex"

Communication:
  dc-send <target> <message>  # 他エージェントにメッセージ送信
  dc-status                   # 各エージェントの状態確認
EOF
}

# 設定表示
show_config() {
  echo -e "${BLUE}═══════════════════════════════════════════════════════${NC}"
  echo -e "${BLUE}  DevCrew Configuration${NC}"
  echo -e "${BLUE}═══════════════════════════════════════════════════════${NC}"
  echo ""
  echo -e "${CYAN}Config file:${NC} $CONFIG_FILE"
  if [ -f "$CONFIG_FILE" ]; then
    echo -e "${GREEN}(loaded)${NC}"
  else
    echo -e "${YELLOW}(not found, using defaults)${NC}"
  fi
  echo ""
  echo -e "${YELLOW}[Team Mode - 4人構成]${NC}"
  echo "  Leader   : $LEADER_AGENT"
  echo "  Coder    : $CODER_AGENT"
  echo "  Reviewer : $REVIEWER_AGENT"
  echo "  Tester   : $TESTER_AGENT"
  echo ""
  echo -e "${YELLOW}[Duo Mode - 2人構成]${NC}"
  echo "  Coder    : $CODER_DUO_AGENT"
  echo "  Reviewer : $REVIEWER_DUO_AGENT"
  echo ""
  echo -e "${YELLOW}[Agent Commands]${NC}"
  echo "  claude : $AGENT_CLAUDE"
  echo "  codex  : $AGENT_CODEX"
  echo ""
  echo -e "${BLUE}═══════════════════════════════════════════════════════${NC}"
}

# セッション終了
kill_session() {
  if tmux has-session -t $SESSION 2>/dev/null; then
    tmux kill-session -t $SESSION
    echo -e "${GREEN}✓ devcrew session terminated${NC}"
  else
    echo -e "${YELLOW}No active devcrew session found${NC}"
  fi
  exit 0
}

# 引数パース
while [[ $# -gt 0 ]]; do
  case $1 in
    -2|--duo)
      MODE="duo"
      shift
      ;;
    -4|--team)
      MODE="team"
      shift
      ;;
    -y|--yolo)
      PERMISSION_MODE="yolo"
      shift
      ;;
    -c|--config)
      show_config
      exit 0
      ;;
    -k|--kill)
      kill_session
      ;;
    -h|--help)
      show_help
      exit 0
      ;;
    -*)
      echo -e "${RED}Unknown option: $1${NC}"
      show_help
      exit 1
      ;;
    *)
      PROJECT_DIR="$1"
      shift
      ;;
  esac
done

# tmux確認
if ! command -v tmux &> /dev/null; then
  echo -e "${RED}Error: tmux is not installed${NC}"
  echo "Install with: brew install tmux"
  exit 1
fi

# プロジェクトディレクトリ
PROJECT_DIR="${PROJECT_DIR:-$(pwd)}"
if [ ! -d "$PROJECT_DIR" ]; then
  echo -e "${RED}Error: Directory not found: $PROJECT_DIR${NC}"
  exit 1
fi
PROJECT_DIR=$(cd "$PROJECT_DIR" && pwd)  # 絶対パスに変換
PROJECT_NAME=$(basename "$PROJECT_DIR")

# 既存セッション確認
if tmux has-session -t $SESSION 2>/dev/null; then
  echo -e "${YELLOW}Existing devcrew session found. Killing it...${NC}"
  tmux kill-session -t $SESSION
fi

echo -e "${BLUE}Starting devcrew in ${MODE} mode...${NC}"
echo -e "Project: ${GREEN}$PROJECT_DIR${NC}"
if [ "$PERMISSION_MODE" = "yolo" ]; then
  echo -e "Permission: ${RED}YOLO (全自動許可)${NC}"
else
  echo -e "Permission: ${GREEN}restricted (dc-*のみ許可)${NC}"
fi
echo ""

if [ "$MODE" = "duo" ]; then
  # ============ 2人構成 ============
  tmux new-session -d -s $SESSION -c "$PROJECT_DIR"
  tmux split-window -h -t $SESSION -c "$PROJECT_DIR"

  # ペインタイトル（エージェント名も表示）
  tmux select-pane -t $SESSION:0.0 -T "Coder ($CODER_DUO_AGENT)"
  tmux select-pane -t $SESSION:0.1 -T "Reviewer ($REVIEWER_DUO_AGENT)"

  # エージェント起動
  CODER_PROMPT="$DEVCREW_HOME/prompts/coder-duo.md"
  REVIEWER_PROMPT="$DEVCREW_HOME/prompts/reviewer-duo.md"

  CODER_CMD=$(get_agent_command "$CODER_DUO_AGENT" "$CODER_PROMPT" "coder")
  REVIEWER_CMD=$(get_agent_command "$REVIEWER_DUO_AGENT" "$REVIEWER_PROMPT" "reviewer")

  tmux send-keys -t $SESSION:0.0 "$CODER_CMD" Enter
  tmux send-keys -t $SESSION:0.1 "$REVIEWER_CMD" Enter

  # yoloモードの場合、Claude Codeのみ確認ダイアログを自動承認
  if [ "$PERMISSION_MODE" = "yolo" ]; then
    sleep 2  # ダイアログ表示を待つ
    [ "$CODER_DUO_AGENT" = "claude" ] && tmux send-keys -t $SESSION:0.0 Down Enter
    [ "$REVIEWER_DUO_AGENT" = "claude" ] && tmux send-keys -t $SESSION:0.1 Down Enter
  fi

  echo -e "${GREEN}✓ Duo mode started${NC}"
  echo "  Pane 0: Coder    ($CODER_DUO_AGENT)"
  echo "  Pane 1: Reviewer ($REVIEWER_DUO_AGENT)"

else
  # ============ 4人構成 ============
  # レイアウト: 上にLeader、下にCoder/Reviewer/Tester
  # +-------------------+
  # |      Leader       |
  # +------+------+-----+
  # |Coder |Revwr |Tester|
  # +------+------+-----+
  tmux new-session -d -s $SESSION -c "$PROJECT_DIR"
  tmux split-window -v -t $SESSION -c "$PROJECT_DIR"           # 上下に分割
  tmux split-window -h -t $SESSION:0.1 -c "$PROJECT_DIR"       # 下を左右に分割
  tmux split-window -h -t $SESSION:0.2 -c "$PROJECT_DIR"       # 下右をさらに分割

  # エージェント設定の配列
  AGENTS=("$LEADER_AGENT" "$CODER_AGENT" "$REVIEWER_AGENT" "$TESTER_AGENT")
  ROLES=("leader" "coder" "reviewer" "tester")
  ROLE_NAMES=("Leader" "Coder" "Reviewer" "Tester")
  PANES=(0 1 2 3)

  # ペインタイトル設定
  for i in "${!ROLES[@]}"; do
    tmux select-pane -t $SESSION:0.${PANES[$i]} -T "${ROLE_NAMES[$i]} (${AGENTS[$i]})"
  done

  # エージェント起動
  for i in "${!ROLES[@]}"; do
    ROLE="${ROLES[$i]}"
    PANE="${PANES[$i]}"
    AGENT="${AGENTS[$i]}"
    PROMPT_FILE="$DEVCREW_HOME/prompts/${ROLE}.md"

    CMD=$(get_agent_command "$AGENT" "$PROMPT_FILE" "$ROLE")
    tmux send-keys -t $SESSION:0.$PANE "$CMD" Enter
  done

  # yoloモードの場合、Claude Codeのみ確認ダイアログを自動承認（Leader以外）
  if [ "$PERMISSION_MODE" = "yolo" ]; then
    sleep 2  # ダイアログ表示を待つ
    # Pane 1: Coder, Pane 2: Reviewer, Pane 3: Tester（Leaderは除く）
    [ "$CODER_AGENT" = "claude" ] && tmux send-keys -t $SESSION:0.1 Down Enter
    [ "$REVIEWER_AGENT" = "claude" ] && tmux send-keys -t $SESSION:0.2 Down Enter
    [ "$TESTER_AGENT" = "claude" ] && tmux send-keys -t $SESSION:0.3 Down Enter
  fi

  echo -e "${GREEN}✓ Team mode started${NC}"
  echo "  Pane 0: Leader   ($LEADER_AGENT)"
  echo "  Pane 1: Coder    ($CODER_AGENT)"
  echo "  Pane 2: Reviewer ($REVIEWER_AGENT)"
  echo "  Pane 3: Tester   ($TESTER_AGENT)"
fi

# UI設定
tmux set -t $SESSION status-left "[$PROJECT_NAME|$MODE] "
tmux set -t $SESSION pane-border-status top
tmux set -t $SESSION pane-border-format " #{pane_title} "

# モード情報を環境変数として保存
tmux set-environment -t $SESSION DEVCREW_MODE "$MODE"
tmux set-environment -t $SESSION DEVCREW_PROJECT "$PROJECT_DIR"
tmux set-environment -t $SESSION DEVCREW_PERMISSION "$PERMISSION_MODE"

# 初期フォーカス設定（Team: Leader, Duo: Coder）
tmux select-pane -t $SESSION:0.0

echo ""
echo -e "${BLUE}Attaching to session...${NC}"
echo "Tips: Ctrl+b d to detach, 'devcrew --kill' to terminate"
echo ""

tmux attach -t $SESSION
